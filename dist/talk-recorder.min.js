parcelRequire=function(e,r,t,n){var i,o="function"==typeof parcelRequire&&parcelRequire,u="function"==typeof require&&require;function f(t,n){if(!r[t]){if(!e[t]){var i="function"==typeof parcelRequire&&parcelRequire;if(!n&&i)return i(t,!0);if(o)return o(t,!0);if(u&&"string"==typeof t)return u(t);var c=new Error("Cannot find module '"+t+"'");throw c.code="MODULE_NOT_FOUND",c}p.resolve=function(r){return e[t][1][r]||r},p.cache={};var l=r[t]=new f.Module(t);e[t][0].call(l.exports,p,l,l.exports,this)}return r[t].exports;function p(e){return f(p.resolve(e))}}f.isParcelRequire=!0,f.Module=function(e){this.id=e,this.bundle=f,this.exports={}},f.modules=e,f.cache=r,f.parent=o,f.register=function(r,t){e[r]=[function(e,r){r.exports=t},{}]};for(var c=0;c<t.length;c++)try{f(t[c])}catch(e){i||(i=e)}if(t.length){var l=f(t[t.length-1]);"object"==typeof exports&&"undefined"!=typeof module?module.exports=l:"function"==typeof define&&define.amd?define(function(){return l}):n&&(this[n]=l)}if(parcelRequire=f,i)throw i;return f}({"FOZT":[function(require,module,exports) {
"use strict";function e(e,r){return e.then(e=>r(null,e)).catch(e=>r(e,result))}function r(e,r,t=null){e.dispatchEvent(new CustomEvent(r,{detail:t}))}function t(e,r){if("string"!=typeof e)return r;const t=e.trim().substr(-1);let n=parseFloat(e);return"k"!==t&&"K"!==t||(n*=1e3),n}function n(e,r){let t;return"copyFromChannel"in e?(t=new Float32Array(e.length),e.copyFromChannel(t,r)):t=e.getChannelData(r).slice(),t}async function o(e){return new Promise((r,t)=>{const n=new FileReader;n.readAsArrayBuffer(e),n.onload=(()=>r(n.result)),n.onerror=(()=>t(n.error))})}async function a(e,r=48e3){const t=new AudioContext({sampleRate:r});return n(await t.decodeAudioData(e),0)}async function s(e,r){if(!window.Worker||!window.WebAssembly)throw new Error("Worker and WebAssembly features not available");return new Promise((t,n)=>{let o;(o=new URL(e).host===window.location.host?new Worker(e):new Worker(URL.createObjectURL(new Blob([`importScripts("${e}");`])))).onmessage=(e=>{switch(e.data.type){case"ready":r(o);break;case"done":o.terminate(),t(e.data.blob)}}),o.onerror=(e=>{n(e)})})}Object.defineProperty(exports,"__esModule",{value:!0}),exports.promiseCallback=e,exports.triggerEvent=r,exports.friendlyFloat=t,exports.getChannelData=n,exports.arrayBufferFromBlob=o,exports.decodeAudioData=a,exports.withWorker=s;
},{}],"uZlT":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TalkLocalService=void 0;var e=require("./utils");const t=window.AudioContext||window.webkitAudioContext,r=navigator.mediaDevices?navigator.mediaDevices.getUserMedia:navigator.getUserMedia,o=document.currentScript?new URL(document.currentScript.src,document.baseURI):null;function a(e){return o?new URL(e,o).toString():e}const s=a("./lamemp3/worker.js");console.log("workerUrl",s);class n{constructor(){}async record(t,o){if(t.stream)throw new Error("already recording");if(!window.MediaRecorder||!window.Worker||!window.WebAssembly)throw new Error("Current browser is not supported by talk-recorder");if(!r&&!t.host&&"https:"!==window.location.protocol&&"localhost"!==window.location.hostname)throw new Error("HTTPS is required for media recording.");o=Object.assign({type:"opus",timeslice:20,workerUrl:s},o);const a=Object.assign({},{audio:!0,video:!1,channelCount:1,autoGainControl:!0,echoCancellation:!0,noiseSuppression:!0},o.getUserMedia);t.stream=await navigator.mediaDevices.getUserMedia(a),(0,e.triggerEvent)(t,"record",{stream:t.stream}),t.addEventListener("stop",e=>{t.stream.getTracks().forEach(e=>e.stop()),t.stream=null},{once:!0});try{let r;return"opus"===o.type?r=await this._recordOpus(t,t.stream,o):"mp3"===o.type&&(r=await this._recordMP3(t,t.stream,o)),(0,e.triggerEvent)(t,"recorded",{blob:r}),r}catch(n){throw(0,e.triggerEvent)(t,"error",{error:n}),n}}stop(t,r){(0,e.triggerEvent)(t,"stop",{reason:r})}async convert(t,r,o={}){(0,e.triggerEvent)(t,"convert");const a=(o=Object.assign({},{sampleRate:48e3,type:"mp3",workerUrl:s},o)).sampleRate||48e3,n=await(0,e.arrayBufferFromBlob)(r),i=await(0,e.decodeAudioData)(n,a),c=t.bitRate||64e3;return(0,e.withWorker)(o.workerUrl,e=>{e.postMessage({type:"init",sampleRate:a,bitRate:c});let t=0,r=i.length;for(;r>0;){const o=r>8192?8192:r,a=new Float32Array(o);a.set(i.slice(t,t+o),0),t+=o,r-=o,e.postMessage({type:"data",data:a.buffer},[a.buffer])}e.postMessage({type:"flush"})}).then(r=>((0,e.triggerEvent)(t,"converted",{blob:r}),r)).catch(r=>{throw(0,e.triggerEvent)(t,"error",{error:r}),r})}async _recordOpus(e,t,r){const o=e.bitRate||32e3,a=Object.assign({},{mimeType:'audio/webm; codecs="opus"',audioBitsPerSecond:o},r.MediaRecorder),s=new MediaRecorder(t,a);return e.addEventListener("stop",({detail:{reason:e}})=>{s&&"recording"===s.state&&s.stop()},{once:!0}),new Promise((e,t)=>{const o=[];s.ondataavailable=(e=>{void 0!==e.data&&e.data.size>0&&o.push(e.data)}),s.onstop=(t=>{o.length>0?e(new Blob(o,{type:o[0].type})):e(null)}),s.onerror=(e=>{t(e.error)}),s.start(r.timeslice)})}async _recordMP3(t,r,o){const a=r.getAudioTracks()[0].getSettings().sampleRate||48e3;return(0,e.withWorker)(o.workerUrl,e=>{const o=t.bitRate||65536;e.postMessage({type:"init",sampleRate:a,bitRate:o}),this._processStream(t,r,t=>{e.postMessage({type:"data",data:t.buffer},[t.buffer])}),t.addEventListener("stop",t=>{e.postMessage({type:"flush"})})})}async _processStream(r,o,a){const s=new t,n=s.createMediaStreamSource(o),i=s.createScriptProcessor(0,1,1);i.onaudioprocess=(t=>a((0,e.getChannelData)(t.inputBuffer,0))),n.connect(i),i.connect(s.destination),r.addEventListener("stop",e=>{n.disconnect()})}}exports.TalkLocalService=n;
},{"./utils":"FOZT"}],"iZjX":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TalkRemoteService=void 0;var e=require("./utils");class r{constructor(){}createServiceFrame(e){const{host:r,role:t}=e,o=document.createElement("iframe");return o.src=r,o.name="talk-service",o.allow="microphone; autoplay","framer"===t?(o.width=0,o.height=0,o.style.display="none"):(o.width=500,o.height=500,o.style.border="none"),o}async record(r,t){if(!r.iframePort)throw new Error("service frame to host failed to open");return new Promise((o,n)=>{r.iframePort.addEventListener("recorded",t=>{const n=t.detail;(0,e.triggerEvent)(r,n.type,n),o(n.blob)},{once:!0}),r.iframePort.addEventListener("error",t=>{const o=t.detail;(0,e.triggerEvent)(r,o.type,o),n(o.error)},{once:!0}),r.iframePort.postMessage({type:"record",options:t}),(0,e.triggerEvent)(r,"record",{})})}stop(r,t){(0,e.triggerEvent)(r,"stop",{reason:t}),r.iframePort&&r.iframePort.postMessage({type:"stop"})}async convert(r,t,o={}){if(!r.iframePort)throw new Error("service frame to host failed to open");return new Promise((n,i)=>{r.iframePort.addEventListener("converted",t=>{const o=t.detail;(0,e.triggerEvent)(r,o.type,o),n(o.blob)},{once:!0}),r.iframePort.addEventListener("error",t=>{const o=t.detail;(0,e.triggerEvent)(r,o.type,o),i(o.error)},{once:!0}),r.iframePort.postMessage({type:"convert",blob:t,options:o}),(0,e.triggerEvent)(r,"convert",{})})}}exports.TalkRemoteService=r;
},{"./utils":"FOZT"}],"z1SI":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.FramePort=void 0;class e extends EventTarget{constructor(e){if(super(),!e)throw new Error("null FramePort constructor argument");if(e instanceof HTMLIFrameElement){if(!e.src)throw new Error("null iframe.src");this.target=e.contentWindow,this.origin=new URL(e.src).origin}else{if(e!==parent)throw new Error("wrong parent");if(e===window)throw new Error("not framed");this.target=e,this.origin=new URL(document.referrer).origin}this._reqCount=0,this._receivers={},this._listener=(e=>e.origin===this.origin&&this._receiveMessage(e)),window.addEventListener("message",this._listener)}close(){window.removeEventListener("message",this._listener),this.target=null,this._receivers={},this._listener=null}postMessage(e,r){if(!e)throw new Error("null msg");this.target.postMessage(e,this.origin,r)}sendRequest(e,r){return new Promise((s,t)=>{this._registerRequest(e,e=>"error"!==e.type?s(e):t(e.error)),this.postMessage(e,r)})}isRequest(e){return"_reqId"in e}sendResponse(e,r,s){this._registerResponse(e,r),this.postMessage(r,s)}sendError(e,r){this.sendResponse(e,{type:"error",error:r})}_receiveMessage(e){const r=e.data;this._dispatchResponse(r)||this.dispatchEvent(new CustomEvent(r.type,{detail:r}))}_registerRequest(e,r){e._reqId=++this._reqCount,this._receivers[e._reqId]=r}_registerResponse(e,r){r._resId=e._reqId}_dispatchResponse(e){const r=e._resId;return!(!r||!this._receivers[r])&&(this._receivers[r](e),delete this._receivers[r],!0)}}exports.FramePort=e;
},{}],"TnXr":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),exports.TalkRecorder=void 0;var e=require("./TalkLocalService"),t=require("./TalkRemoteService"),r=require("./FramePort"),i=require("./utils");function s(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class o extends HTMLElement{constructor(){super()}attributeChangedCallback(e,t,r){switch(e){case"bitrate":this.bitRate=(0,i.friendlyFloat)(r,t);break;case"host":this.host=r;break;case"role":console.log("role",{oldValue:t,newValue:r}),"string"==typeof r&&(this.role=r.trim().toLowerCase())}}connectedCallback(){a.apply(this)}disconnectedCallback(){}adoptedCallback(){}isSupported(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia&&window.MediaRecorder&&window.Worker&&window.WebAssembly}async record(e={}){if(a.apply(this),"opus"!==(e=Object.assign({},{type:"opus"},e)).type&&"mp3"!==e.type)throw new Error("unknown recording type");return this.service.record(this,e)}async stop(e="finish"){if(this.service)return this.service.stop(this,e)}async convert(e,t={}){return a.apply(this),this.service.convert(this,e,t)}}function a(){this._inited||(this._inited=!0,this.host?(this.service=new t.TalkRemoteService,this.iframe=this.service.createServiceFrame(this),this.appendChild(this.iframe),this.iframePort=new r.FramePort(this.iframe)):(this.service=new e.TalkLocalService,"framed"===this.role&&parent!==window&&(this.parentPort=new r.FramePort(parent),this.parentPort.addEventListener("record",e=>{const t=e.detail;this.record(t.options)}),this.parentPort.addEventListener("stop",e=>{const t=e.detail;this.stop(t.reason)}),this.parentPort.addEventListener("convert",e=>{const t=e.detail;this.convert(t.blob,t.options)}),this.addEventListener("recorded",e=>{const{blob:t}=e.detail;this.parentPort.postMessage({type:"recorded",blob:t})}),this.addEventListener("converted",e=>{const{blob:t}=e.detail;this.parentPort.postMessage({type:"converted",blob:t})}))))}exports.TalkRecorder=o,s(o,"observedAttributes",["bitrate","host","role"]);
},{"./TalkLocalService":"uZlT","./TalkRemoteService":"iZjX","./FramePort":"z1SI","./utils":"FOZT"}],"q5gj":[function(require,module,exports) {
"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("./TalkRecorder");Object.keys(e).forEach(function(r){"default"!==r&&"__esModule"!==r&&Object.defineProperty(exports,r,{enumerable:!0,get:function(){return e[r]}})}),"undefined"!=typeof window&&(window.TalkRecorder=e.TalkRecorder,"customElements"in window&&customElements.define("talk-recorder",e.TalkRecorder));
},{"./TalkRecorder":"TnXr"}]},{},["q5gj"], null)
//# sourceMappingURL=/talk-recorder.min.js.map